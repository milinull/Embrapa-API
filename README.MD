# ğŸ‡ Embrapa Wine Data Analytics Platform

<div align="center">

![Python](https://img.shields.io/badge/python-3.12-blue)
![Django](https://img.shields.io/badge/Django-REST%20Framework-success)
![MongoDB](https://img.shields.io/badge/Database-MongoDB-green)
![Apache Spark](https://img.shields.io/badge/BigData-Apache%20Spark-orange)
![React](https://img.shields.io/badge/Frontend-React-61DAFB)
![Docker](https://img.shields.io/badge/Container-Docker-blue)
![AWS S3](https://img.shields.io/badge/Storage-AWS_S3-FF9900)
![Django CI](https://github.com/milinull/Embrapa-API/workflows/Django%20CI%2FCD/badge.svg)
![Coverage](https://img.shields.io/badge/coverage-96%25-brightgreen)

**Plataforma completa de anÃ¡lise de dados da indÃºstria vinÃ­cola brasileira**

[VisÃ£o Geral](#-visÃ£o-geral) â€¢ [Arquitetura](#ï¸-arquitetura) â€¢ [InstalaÃ§Ã£o](#-instalaÃ§Ã£o-rÃ¡pida) â€¢ [Testes](#-testes-e-qualidade) â€¢ [CI/CD](#-cicd-e-automaÃ§Ã£o) â€¢ [DocumentaÃ§Ã£o](#-documentaÃ§Ã£o-da-api) â€¢ [Tecnologias](#-stack-tecnolÃ³gico)

</div>

---

## ğŸ“‹ VisÃ£o Geral

Pipeline end-to-end de engenharia de dados que coleta, processa e visualiza informaÃ§Ãµes sobre a **produÃ§Ã£o, comercializaÃ§Ã£o, exportaÃ§Ã£o e importaÃ§Ã£o de vinhos no Brasil**, utilizando dados pÃºblicos da **Embrapa Uva & Vinho**.

### âœ¨ Principais Funcionalidades

- ğŸ”„ **ETL automatizado** com Apache Spark e armazenamento em camadas (Bronze/Silver)
- ğŸ“Š **Dashboard interativo** com visualizaÃ§Ãµes dinÃ¢micas e filtros avanÃ§ados
- ğŸš€ **API RESTful** escalÃ¡vel com Django e MongoDB
- ğŸ³ **Infraestrutura containerizada** com Docker Compose
- â˜ï¸ **IntegraÃ§Ã£o com AWS S3** para data lake
- ğŸ“ˆ **AnÃ¡lises comparativas** de produÃ§Ã£o vs exportaÃ§Ã£o
- âœ… **96% de cobertura** de testes automatizados
- ğŸ”„ **CI/CD automatizado** com GitHub Actions

---

## ğŸ—ï¸ Arquitetura

```mermaid
graph TD
    subgraph Cloud["â˜ï¸ AWS S3 Data Lake"]
        A1[ğŸ“¦ Bronze Layer<br/>Raw Data]
        A2[âœ¨ Silver Layer<br/>Cleaned Data]
    end

    subgraph Spark["âš™ï¸ Apache Spark ETL"]
        B1[ğŸ•·ï¸ Web Scraping<br/>Embrapa Source]
        B2[ğŸ”§ Data Transformation<br/>Cleaning & Typing]
        B3[ğŸ’¾ MongoDB Loader<br/>Batch Insert]
    end

    subgraph Backend["ğŸ”Œ Django REST API"]
        C1[ğŸ¯ REST Endpoints<br/>MongoEngine ORM]
        C2[ğŸ” Authentication]
    end

    subgraph Frontend["ğŸ’» React Dashboard"]
        D1[ğŸ“Š Recharts Visualizations]
        D2[ğŸ¨ Interactive Filters]
    end

    subgraph Database["ğŸ—„ï¸ MongoDB Cluster"]
        E1[ğŸ“š Collections<br/>Wine Data]
        E2[ğŸ–¥ï¸ Mongo Express<br/>Admin UI]
    end

    B1 -->|Extract| A1
    A1 -->|Transform| B2
    B2 -->|Load| A2
    A2 -->|Read| B3
    B3 -->|Insert| E1
    E1 <-->|Query| C1
    C1 <-->|REST API| D1
    E2 -.->|Monitor| E1
```

---

## ğŸ³ ServiÃ§os Docker

| ServiÃ§o | DescriÃ§Ã£o | Portas | URL de Acesso |
|---------|-----------|--------|---------------|
| **web** | Django REST API | `8000` | http://localhost:8000/api |
| **mongo** | MongoDB Database | `27017` | - |
| **mongo-express** | MongoDB Admin UI | `8081` | http://localhost:8081 |
| **spark-master** | Spark + Jupyter Notebook | `8889`, `8083`, `8040`, `7077` | http://localhost:8889 |
| **wine-frontend** | React Dashboard | `3000` | http://localhost:3000 |

---

## ğŸš€ InstalaÃ§Ã£o RÃ¡pida

### PrÃ©-requisitos

- Docker 20.10+
- Docker Compose 2.0+
- Conta AWS (para S3)

### 1. Clone o repositÃ³rio

```bash
git clone https://github.com/milinull/Embrapa-API.git
cd Embrapa-API
```

### 2. Configure as variÃ¡veis de ambiente

Crie um arquivo `.env` na raiz do projeto:

```bash
# Django Settings
DEBUG=True

# MongoDB Configuration
MDB_HOST=mongo
MDB_PORT=27017
MDB_USER=admin
MDB_PASS=admin123
MDB_NAME=embrapa_wine

# AWS S3 Configuration
AWS_ACCESS_KEY=your-access-key
AWS_SECRET_KEY=your-secret-key
AWS_DESTINY=your-bucket-name
AWS_LOCAL=us-east-1
```

### 3. Execute a aplicaÃ§Ã£o

```bash
docker compose up --build
```

Aguarde alguns minutos enquanto os containers sÃ£o construÃ­dos e inicializados.

### 4. Acesse as aplicaÃ§Ãµes

| AplicaÃ§Ã£o | URL | Credenciais |
|-----------|-----|-------------|
| **Dashboard** | http://localhost:3000 | - |
| **API Django**| http://localhost:8000/api | - |
| **Mongo Express** | http://localhost:8081 | admin / admin123 |
| **Jupyter Notebook** | http://localhost:8889 | Token exibido no log |
| **Swagger UI** | http://localhost:8000/swagger | JWT |
| **ReDoc** | http://localhost:8000/redoc | - |

---

## ğŸ§ª Testes e Qualidade

O projeto possui **32 testes unitÃ¡rios automatizados** cobrindo **96% do cÃ³digo** da API.

### ğŸ“Š Cobertura de Testes

| MÃ³dulo | Cobertura | Status |
|--------|-----------|--------|
| **Views** | 98% | âœ… |
| **Serializers** | 100% | âœ… |
| **URLs** | 100% | âœ… |
| **Models** | 89% | âœ… |
| **Total** | **96%** | âœ… |

### Executar Testes

#### Rodar todos os testes

```bash
# Via Docker
docker compose exec web python manage.py test embrapa

# Localmente
python manage.py test embrapa
```

#### Executar com relatÃ³rio de cobertura

```bash
# Via Docker
docker compose exec web coverage run --source='.' manage.py test embrapa
docker compose exec web coverage report

# Localmente
coverage run --source='.' manage.py test embrapa
coverage report
```

#### Visualizar cobertura detalhada (HTML)

```bash
coverage html
# Abra htmlcov/index.html no navegador
```

### ğŸ¯ O que Ã© testado?

âœ… **Listagem de endpoints** - Verifica se todos os endpoints retornam dados corretamente  
âœ… **Filtros e query params** - Testa filtros por ano, categoria, produto, paÃ­s, tipo e cultivar  
âœ… **Actions customizadas** - `total_por_ano`, `top_paises`  
âœ… **Comparativo produÃ§Ã£o x exportaÃ§Ã£o** - ValidaÃ§Ã£o de cÃ¡lculos e percentuais  
âœ… **OrdenaÃ§Ã£o de resultados** - Verifica ordenaÃ§Ã£o por ano decrescente  
âœ… **PaginaÃ§Ã£o** - NavegaÃ§Ã£o entre pÃ¡ginas de resultados  
âœ… **Tratamento de erros** - Casos de dados invÃ¡lidos ou inexistentes  

### Exemplo de SaÃ­da

```bash
Found 32 test(s).
Creating test database for alias 'default'...
System check identified no issues (0 silenced).
................................
----------------------------------------------------------------------
Ran 32 tests in 0.337s
OK
Destroying test database for alias 'default'...

Name                     Stmts   Miss  Cover
--------------------------------------------
embrapa/views.py           111      2    98%
embrapa/serializers.py      22      0   100%
embrapa/models.py           44      5    89%
embrapa/urls.py             10      0   100%
--------------------------------------------
TOTAL                      501     21    96%
```

---

## ğŸ”„ CI/CD e AutomaÃ§Ã£o

O projeto utiliza **GitHub Actions** para integraÃ§Ã£o e entrega contÃ­nuas, garantindo qualidade do cÃ³digo a cada push.

### ğŸš€ Pipeline Automatizado

```mermaid
graph LR
    A[ğŸ’» Git Push] --> B[ğŸ” GitHub Actions]
    B --> C[ğŸ§ª Testes UnitÃ¡rios]
    B --> D[ğŸ“ Code Linting]
    C --> E{âœ… Passou?}
    D --> E
    E -->|Sim| F[âœ¨ Deploy Ready]
    E -->|NÃ£o| G[âŒ Bloqueado]
```

### Workflow de CI/CD

A cada **push** ou **pull request** nas branches `main` ou `develop`, o GitHub Actions executa automaticamente:

#### 1ï¸âƒ£ **Job: Test**
- âœ… Configura ambiente Python 3.12
- âœ… Sobe container MongoDB para testes
- âœ… Instala dependÃªncias
- âœ… Executa 32 testes unitÃ¡rios
- âœ… Gera relatÃ³rio de cobertura (96%)
- âœ… Valida que nenhum teste falhou

#### 2ï¸âƒ£ **Job: Lint**
- âœ… Executa **Flake8** para verificar erros de sintaxe
- âœ… Executa **Black** para validar formataÃ§Ã£o do cÃ³digo
- âœ… Garante padrÃ£o de cÃ³digo consistente

<p>


VocÃª pode ver o status de todos os workflows em: [Actions](https://github.com/milinull/Embrapa-API/actions)

### Arquivo de ConfiguraÃ§Ã£o

O pipeline estÃ¡ definido em `.github/workflows/django-tests.yml`:

```yaml
name: Django CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Run tests with coverage
        run: |
          coverage run --source='.' manage.py test embrapa
          coverage report

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Run flake8
        run: flake8 .
      - name: Check formatting with black
        run: black --check .
```
---

## ğŸ” AutenticaÃ§Ã£o JWT

A API utiliza **JSON Web Tokens (JWT)** para autenticaÃ§Ã£o segura.

### Obtendo Token de Acesso

```bash
# RequisiÃ§Ã£o
POST http://localhost:8000/api/token/
Content-Type: application/json

{
  "username": "seu_usuario",
  "password": "sua_senha"
}

# Resposta
{
  "access": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### Usando o Token

```bash
# Adicione o token no header Authorization
GET http://localhost:8000/api/Producao/?ano=2024
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Renovando o Token

```bash
POST http://localhost:8000/api/token/refresh/
Content-Type: application/json

{
  "refresh": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### Testando no Swagger

1. Acesse http://localhost:8000/swagger/
2. Clique no botÃ£o **"Authorize"** ğŸ”“
3. Digite: `Bearer seu_token_aqui`
4. Clique em **"Authorize"** e depois **"Close"**
5. Agora vocÃª pode testar os endpoints autenticados!

---

## ğŸ“Š Dashboard Interativo

O dashboard React oferece anÃ¡lises visuais completas com:

### Funcionalidades

- **ğŸ“ˆ MÃºltiplas visualizaÃ§Ãµes**: GrÃ¡ficos de barras, pizza e linhas temporais
- **ğŸ” Filtros dinÃ¢micos**: Por ano, categoria e paÃ­s
- **ğŸ“‘ Sistema de abas**: ComercializaÃ§Ã£o, ProduÃ§Ã£o, ExportaÃ§Ã£o, ImportaÃ§Ã£o e Processamento
- **ğŸ’¹ Comparativos**: AnÃ¡lise de produÃ§Ã£o vs exportaÃ§Ã£o
- **ğŸ“± Responsivo**: Interface adaptÃ¡vel para mobile e desktop

Acesse em: http://localhost:3000

---

## ğŸ”„ Pipeline ETL

### Fluxo de Dados

```
1. EXTRAÃ‡ÃƒO â†’ Web scraping da Embrapa (BeautifulSoup)
                â†“
2. BRONZE LAYER â†’ Dados brutos salvos no S3
                â†“
3. TRANSFORMAÃ‡ÃƒO â†’ Limpeza e tipagem com Spark
                â†“
4. SILVER LAYER â†’ Dados processados no S3
                â†“
5. CARGA â†’ InserÃ§Ã£o em batch no MongoDB
```

### Notebooks Spark

1. **`scrap_embrapa.ipynb`** - ExtraÃ§Ã£o de dados
   - Web scraping das pÃ¡ginas da Embrapa
   - Parsing de tabelas HTML
   - Upload para S3 (bronze layer)

2. **`spark_transform.ipynb`** - TransformaÃ§Ã£o
   - Limpeza de caracteres especiais
   - ConversÃ£o de tipos de dados
   - ValidaÃ§Ã£o e normalizaÃ§Ã£o
   - GeraÃ§Ã£o da silver layer

3. **`MongoDBLoaderFromS3.py`** - Carga
   - Leitura batch do S3
   - InserÃ§Ã£o otimizada no MongoDB
   - Logging e tratamento de erros

---

## ğŸ“¡ DocumentaÃ§Ã£o da API

### Endpoints DisponÃ­veis

#### ComercializaÃ§Ã£o
```http
GET /api/Comercio/?ano=2024
```
Retorna dados de comercializaÃ§Ã£o de vinhos no mercado interno.

#### ProduÃ§Ã£o
```http
GET /api/Producao/?ano=2024
```
Dados de produÃ§Ã£o de vinhos e derivados.

#### ExportaÃ§Ã£o
```http
GET /api/Exportacao/?ano=2024&pais=Italia
```
Volume e valor de exportaÃ§Ãµes por paÃ­s de destino.

#### ImportaÃ§Ã£o
```http
GET /api/Importacao/?ano=2024&pais=Argentina
```
Volume e valor de importaÃ§Ãµes por paÃ­s de origem.

#### Processamento
```http
GET /api/Processamento/?ano=2024
```
Quantidade de uvas processadas por variedade.

#### Comparativo
```http
GET /api/comparativo/2024/
```
AnÃ¡lise comparativa entre produÃ§Ã£o e exportaÃ§Ã£o.

### Exemplo de Resposta

```json
{
  "ano": 2024,
  "data": [
    {
      "produto": "Vinho de Mesa",
      "quantidade": 125000000,
      "valor": 450000000
    }
  ],
  "total_registros": 15
}
```

---

## ğŸ› ï¸ Stack TecnolÃ³gico

### Backend
- **Django 5.2+** - Framework web
- **Django REST Framework** - API RESTful
- **MongoEngine** - ODM para MongoDB
- **python-decouple** - Gerenciamento de variÃ¡veis

### Big Data & ETL
- **Apache Spark 3.5** - Processamento distribuÃ­do
- **PySpark** - Interface Python para Spark
- **boto3** - SDK AWS para Python
- **BeautifulSoup4** - Web scraping

### Database
- **MongoDB 8.2** - Banco de dados NoSQL
- **PyMongo** - Driver Python para MongoDB

### Frontend
- **React** - Biblioteca UI
- **Recharts** - Biblioteca de grÃ¡ficos
- **Lucide React** - Ãcones

### Infraestrutura & DevOps
- **Docker & Docker Compose** - ContainerizaÃ§Ã£o
- **AWS S3** - Object storage (Data Lake)
- **GitHub Actions** - CI/CD
- **Coverage.py** - AnÃ¡lise de cobertura de testes
- **Black** - FormataÃ§Ã£o de cÃ³digo
- **Flake8** - Linting

---

## ğŸ“ Estrutura do Projeto

```
embrapa-wine-data/
â”œâ”€â”€ ğŸ“‚ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ django-tests.yml       # Pipeline CI/CD
â”œâ”€â”€ ğŸ“‚ embrapa/                    # App Django principal
â”‚   â”œâ”€â”€ models.py                  # Models MongoEngine
â”‚   â”œâ”€â”€ views.py                   # ViewSets da API
â”‚   â”œâ”€â”€ serializers.py             # Serializadores DRF
â”‚   â”œâ”€â”€ tests.py                   # 32 testes unitÃ¡rios
â”‚   â””â”€â”€ urls.py                    # Rotas da API
â”œâ”€â”€ ğŸ“‚ mongo/                      # ConfiguraÃ§Ã£o MongoDB
â”‚   â”œâ”€â”€ connection.py              # Setup de conexÃ£o
â”‚   â””â”€â”€ MongoDBLoaderFromS3.py     # Carga
â”œâ”€â”€ ğŸ“‚ src/spark/spark-apps/       # Pipeline ETL
â”‚   â”œâ”€â”€ scrap_embrapa.ipynb        # ExtraÃ§Ã£o
â”‚   â””â”€â”€ spark_transform.ipynb      # TransformaÃ§Ã£o
â”œâ”€â”€ ğŸ“‚ wine-frontend/              # AplicaÃ§Ã£o React
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ public/                # Componentes React
â”‚   â”‚   â””â”€â”€ src/                   # Componente principal
â”œâ”€â”€ ğŸ“‚ setup/                      # ConfiguraÃ§Ãµes Django
â”‚   â”œâ”€â”€ settings.py
â”‚   â””â”€â”€ urls.py
â”œâ”€â”€ ğŸ“„ docker-compose.yml          # OrquestraÃ§Ã£o
â”œâ”€â”€ ğŸ“„ Dockerfile                  # Build Django
â”œâ”€â”€ ğŸ“„ requirements.txt            # DependÃªncias Python
â”œâ”€â”€ ğŸ“„ .env                        # Template de variÃ¡veis
â””â”€â”€ ğŸ“„ README.md                   # Este arquivo
```

---

## ğŸ§ª Desenvolvimento

### Executar Django localmente

```bash
# Criar ambiente virtual
python -m venv venv
source venv/bin/activate  # Linux/Mac
# ou
venv\Scripts\activate  # Windows

# Instalar dependÃªncias
pip install -r requirements.txt

# Executar servidor
python manage.py runserver
```

### Executar Frontend localmente

```bash
cd wine-frontend
npm install
npm start
```

### Acessar Jupyter Notebooks

```bash
# O token estÃ¡ nos logs do container
docker compose logs spark-master | grep token

# Acesse http://localhost:8889 e insira o token
```

### FormataÃ§Ã£o de CÃ³digo

```bash
# Formatar cÃ³digo automaticamente
black .

# Verificar formataÃ§Ã£o sem modificar
black --check .

# Executar linting
flake8 .
```

---

## ğŸ“ˆ Roadmap

- [x] ~~Implementar autenticaÃ§Ã£o JWT na API~~
- [x] ~~Adicionar documentaÃ§Ã£o Swagger/ReDoc~~
- [x] ~~Criar testes automatizados (96% cobertura)~~
- [x] ~~Pipeline CI/CD com GitHub Actions~~
- [x] ~~Implementar linting e formataÃ§Ã£o automÃ¡tica~~
- [ ] Adicionar cache com Redis
- [ ] Adicionar forecasting com ML
- [ ] Implementar notificaÃ§Ãµes em tempo real
- [ ] Dashboard de monitoramento (Grafana)
- [ ] Deploy automatizado em produÃ§Ã£o

---